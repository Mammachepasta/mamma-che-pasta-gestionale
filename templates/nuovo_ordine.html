{% extends "base.html" %}
{% block content %}

<div class="container mt-4">

    <h2>Nuovo Ordine</h2>
    <hr>

    <form method="POST">

        <!-- DATA -->
        <div class="mb-3">
            <label class="form-label">Data ordine</label>
            <input class="form-control" type="date" name="data"
                   value="{{ current_date }}">
        </div>

        <!-- CLIENTE con ricerca -->
        <div class="mb-3">
            <label class="form-label"><b>Cliente</b></label>

            <!-- CAMPO DI RICERCA -->
            <input id="searchCliente" class="form-control mb-2" type="text"
                   placeholder="Cerca cliente per nome o codice...">

            <!-- SELECT CLIENTI -->
            <select class="form-control" name="cliente_id" id="clienteSelect" required>
                <option value="">-- seleziona cliente --</option>
                {% for c in clienti %}
                    <option value="{{ c.id }}">
                        {{ c.codice or '' }} - {{ c.nome }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <hr>

        <h4>Prodotti ordinati</h4>

        <div id="righeContainer">
            <!-- Qui JS aggiunge nuove righe -->
        </div>

        <button type="button" class="btn btn-secondary mt-2" onclick="aggiungiRiga()">
            ‚ûï Aggiungi prodotto
        </button>

        <hr>

        <button type="submit" class="btn btn-primary btn-lg">üíæ Salva ordine</button>

    </form>

</div>


<script>
// ------------------ RICERCA CLIENTI ------------------
document.getElementById("searchCliente").addEventListener("keyup", function () {

    let filtro = this.value.toLowerCase();
    let select = document.getElementById("clienteSelect");

    for (let option of select.options) {
        let txt = option.text.toLowerCase();
        option.style.display = txt.includes(filtro) ? "block" : "none";
    }
});


// ------------------ AGGIUNGI RIGA PRODOTTO ------------------
let rigaIndex = 0;

function aggiungiRiga() {

    let html = `
    <div class="card p-3 mt-3">
        <div class="row">

            <!-- Ricerca prodotto -->
            <div class="col-md-5">
                <label class="form-label">Prodotto</label>

                <input type="text" class="form-control mb-2"
                       placeholder="Cerca prodotto..."
                       onkeyup="filtraProdotti(this, 'prodotto_${rigaIndex}')">

                <select class="form-control"
                        name="prodotto_${rigaIndex}"
                        id="prodotto_${rigaIndex}"
                        required>
                    <option value="">-- seleziona prodotto --</option>
                    {% for p in prodotti %}
                        <option value="{{ p.id }}">
                            {{ p.codice or '' }} - {{ p.nome }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Quantit√† -->
            <div class="col-md-3">
                <label class="form-label">Quantit√†</label>
                <input type="number" step="0.01" min="0"
                       name="qta_${rigaIndex}" class="form-control" required>
            </div>

            <!-- Tipo quantit√† -->
            <div class="col-md-2">
                <label class="form-label">Unit√†</label>
                <select name="tipo_${rigaIndex}" class="form-control">
                    <option value="kg">Kg</option>
                    <option value="v">Vaschette</option>
                </select>
            </div>

            <!-- Rimuovi -->
            <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-danger w-100"
                        onclick="this.parentNode.parentNode.parentNode.remove()">
                    ‚ùå Rimuovi
                </button>
            </div>
        </div>
    </div>
    `;

    document.getElementById("righeContainer").insertAdjacentHTML("beforeend", html);
    rigaIndex++;
}


// ------------------ FILTRO PRODOTTI ------------------
function filtraProdotti(input, selectId) {
    let filtro = input.value.toLowerCase();
    let select = document.getElementById(selectId);

    for (let option of select.options) {
        let txt = option.text.toLowerCase();
        option.style.display = txt.includes(filtro) ? "block" : "none";
    }
}
</script>

{% endblock %}
